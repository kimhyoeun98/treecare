<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>íŠ¸ë¦¬ì¼€ì–´ - ì‹œë¯¼ ì°¸ì—¬</title>
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼ */
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 50px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }

        .header h3 {
            margin: 0;
        }

        #my-points {
            font-size: 16px;
            font-weight: bold;
        }

        #map {
            width: 100%;
            height: calc(100% - 52px);
        }

        .infowindow-content {
            padding: 15px;
            font-size: 14px;
            line-height: 1.6;
            width: 280px;
        }

        .infowindow-content .title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .infowindow-content button {
            margin-top: 5px;
            padding: 8px 12px;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .adopt-btn {
            background-color: #28a745;
        }

        .water-btn {
            background-color: #007bff;
        }

        .disabled-btn {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

    <div class="header">
        <h3>ğŸŒ³ ìš°ë¦¬ ë™ë„¤ ë‚˜ë¬´ ëŒë³´ê¸° ğŸŒ³</h3>
        <div id="my-points">ë‚´ í¬ì¸íŠ¸: <span id="points-value">0</span> P</div>
    </div>
    <div id="map"></div>

    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dfb25b13fdfefb4a64d2bb0b2beb4084&libraries=services"></script>

    <script>
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(37.4200, 127.1266), level: 8 };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        let userPoints = 0;
        const adoptedTreeIds = new Set();
        const markers = [];
        let openedInfoWindow = null;

        // ë§ˆì»¤ ì´ë¯¸ì§€ ì •ì˜ 
        const imageSrcGreen = './images/marker_green.png';
        const imageSrcRed = './images/marker_red.png';
        const imageSrcBlue = './images/marker_blue.png';
        const imageSrcGray = './images/marker_gray.png';
        const imageSrcOrange = './images/marker_orange.png';
        const markerImageSize = new kakao.maps.Size(24, 35);
        const markerImageGreen = new kakao.maps.MarkerImage(imageSrcGreen, markerImageSize);
        const markerImageRed = new kakao.maps.MarkerImage(imageSrcRed, markerImageSize);
        const markerImageBlue = new kakao.maps.MarkerImage(imageSrcBlue, markerImageSize);
        const markerImageGray = new kakao.maps.MarkerImage(imageSrcGray, markerImageSize);
        const markerImageOrange = new kakao.maps.MarkerImage(imageSrcOrange, markerImageSize);

        fetch('trees.json')
            .then(response => response.json())
            .then(treeData => {
                treeData.forEach((data, index) => {
                    data.id = index;
                    // â˜…â˜…â˜… 'ë‹¤ë¥¸ ì‚¬ìš©ì'ê°€ ì…ì–‘í•œ ë‚˜ë¬´ ì‹œë®¬ë ˆì´ì…˜ â˜…â˜…â˜…
                    data.owner = null;
                    if (index % 15 === 0) { // 15ê·¸ë£¨ ì¤‘ 1ê·¸ë£¨ëŠ” ë‹¤ë¥¸ ì‚¬ëŒì´ ì…ì–‘í–ˆë‹¤ê³  ê°€ì •
                        data.owner = 'other_user';
                    }


                    // â˜…â˜…â˜… ë§ˆì»¤ í‘œì‹œ ë¡œì§  â˜…â˜…â˜…
                    let markerImage;
                    if (data.owner === 'other_user') { // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì…ì–‘í•œ ë‚˜ë¬´
                        markerImage = markerImageGray;
                    } else if (data.moisture < 40) { // ìœ„í—˜í•œ ë‚˜ë¬´
                        markerImage = markerImageRed;
                    } else if (data.moisture < 60) {
                        markerImage = markerImageOrange; // ì£¼ì˜ ë‚˜ë¬´
                    } else {
                        markerImage = markerImageGreen; // ê±´ê°•í•œ ë‚˜ë¬´
                    }

                    const position = new kakao.maps.LatLng(data.lat, data.lng);
                    const marker = new kakao.maps.Marker({ map, position, title: data.title, image: markerImage });
                    const infowindow = new kakao.maps.InfoWindow({ removable: true });

                    kakao.maps.event.addListener(marker, 'click', function () {
                        infowindow.setContent(getInfoWindowContent(data));
                        if (openedInfoWindow === infowindow) {
                            infowindow.close();
                            openedInfoWindow = null;
                        } else {
                            if (openedInfoWindow) openedInfoWindow.close();
                            infowindow.open(map, marker);
                            openedInfoWindow = infowindow;
                        }
                    });
                    markers.push({ marker, infowindow, data });
                });
            })
            .catch(error => console.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì—ëŸ¬ ë°œìƒ:', error));

        function getInfoWindowContent(data) {
            const isAdoptedByMe = adoptedTreeIds.has(data.id);
            const isAdoptedByOther = data.owner === 'other_user';
            const needsWater = data.moisture < 40;
            const cautionWater = data.moisture < 60;
            const moistureInfo = `<span>í† ì–‘ ìˆ˜ë¶„: ${data.moisture}%</span><br>`;
            let buttonHtml = '';

            if (isAdoptedByMe) {
                buttonHtml = `<button class="water-btn" onclick="waterMyTree(${data.id})">ë¬¼ ì£¼ê¸° (ë‚´ ë‚˜ë¬´)ğŸ’§</button>`;
            } else if (isAdoptedByOther) {
                buttonHtml = `<button class="disabled-btn" disabled>ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì…ì–‘í•œ ë‚˜ë¬´</button>`;
            } else { // ì£¼ì¸ ì—†ëŠ” ë‚˜ë¬´
                if (needsWater || cautionWater) {
                    // ë¬¼ ë¶€ì¡± ì‹œ, ì…ì–‘ê³¼ ë¬¼ì£¼ê¸° ë²„íŠ¼ ëª¨ë‘ í‘œì‹œ
                    buttonHtml = `<button class="adopt-btn" onclick="adoptTree(${data.id})">ì…ì–‘í•˜ê¸°</button>
                              <button class="water-btn" onclick="waterPublicTree(${data.id})">ë¬¼ ì£¼ê¸°</button>`;
                } else {
                    // ê±´ê°•í•˜ë©´ ì…ì–‘ ë²„íŠ¼ë§Œ í‘œì‹œ
                    buttonHtml = `<button class="adopt-btn" onclick="adoptTree(${data.id})">ì…ì–‘í•˜ê¸°</button>`;
                }
            }
            return `<div class="infowindow-content"><div class="title">${data.title}</div>${moistureInfo}${buttonHtml}</div>`;
        }

        function adoptTree(treeId) {
            adoptedTreeIds.add(treeId);
            const tree = markers.find(m => m.data.id === treeId);
            if (tree) {
                tree.marker.setImage(markerImageBlue);
                tree.infowindow.setContent(getInfoWindowContent(tree.data));
            }
            alert(`${tree.data.title} ë‚˜ë¬´ë¥¼ ì…ì–‘í–ˆìŠµë‹ˆë‹¤!`);
        }

        // â˜…â˜…â˜… 'ë‚´ ë‚˜ë¬´'ì— ë¬¼ ì£¼ê¸° í•¨ìˆ˜ â˜…â˜…â˜…
        function waterMyTree(treeId) {
            const tree = markers.find(m => m.data.id === treeId);
            if (!tree) return;
            if (tree.data.moisture < 60) {
                tree.data.moisture = 100;
                tree.marker.setImage(markerImageBlue);
                userPoints += 10; // ë‚´ ë‚˜ë¬´ëŠ” 10 í¬ì¸íŠ¸
                document.getElementById('points-value').innerText = userPoints;
                alert(`ë‚´ ë‚˜ë¬´ì— ë¬¼ì„ ì£¼ì…¨ë„¤ìš”! ê³ ë§™ìŠµë‹ˆë‹¤.\n(+10 í¬ì¸íŠ¸ íšë“!)`);
            } else {
                alert('ì´ ë‚˜ë¬´ëŠ” ì´ë¯¸ ê±´ê°•í•œ ìƒíƒœì…ë‹ˆë‹¤!');
            }
            tree.infowindow.close();
            openedInfoWindow = null;
        }

        // â˜…â˜…â˜… 'ì£¼ì¸ ì—†ëŠ” ë‚˜ë¬´'ì— ë¬¼ ì£¼ê¸° í•¨ìˆ˜ â˜…â˜…â˜…
        function waterPublicTree(treeId) {
            const tree = markers.find(m => m.data.id === treeId);
            if (!tree) return;
            if (tree.data.moisture < 60) {
                tree.data.moisture = 100;
                tree.marker.setImage(markerImageGreen); // ì£¼ì¸ ì—†ëŠ” ë‚˜ë¬´ëŠ” ê·¸ëƒ¥ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½
                userPoints += 5; // ê³µê³µ í™œë™ì€ 5 í¬ì¸íŠ¸
                document.getElementById('points-value').innerText = userPoints;
                alert(`ì£¼ì¸ ì—†ëŠ” ë‚˜ë¬´ë¥¼ ëŒë´ì£¼ì…¨êµ°ìš”! ê°ì‚¬í•©ë‹ˆë‹¤.\n(+5 í¬ì¸íŠ¸ íšë“!)`);
            }
            tree.infowindow.close();
            openedInfoWindow = null;
        }

    </script>
</body>

</html>